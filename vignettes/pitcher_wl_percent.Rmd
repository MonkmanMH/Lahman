---
title: "Pitcher win-loss records"
author: "Martin Monkman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Pitcher win-loss records}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Pitcher win-loss records: data wrangling and tables


This vignette demonstrates how to create a summary table to show the pitchers with the poorest win-loss percentages. Many packages have been developed to generate display tables (that is, with more formatting that a data frame or tibble output); this vignette will look at **gt** and **kable**

Our research question is to find out for each of the two major leagues of baseball, of all the pitchers who recorded more than 50 [decisions](https://en.wikipedia.org/wiki/Win%E2%80%93loss_record_(pitching)) (that is, credited with a "win" or "loss") in that league, which one had the worst percentage record. 

(Note: when we speak of the "major leagues", we usually mean the National and American Leagues. The Lahman database also contains the data for the short-lived [Federal League](https://en.wikipedia.org/wiki/Federal_League) which operated in 1914 and 1915. We will filter the Federal League data out.)

First, we load the necessary packages: **Lahman** (containing the baseball data), the data carpentry package [**dplyr**](https://dplyr.tidyverse.org/), and the packages for creating tables:

* [**gt**](https://gt.rstudio.com/) and

* [**knitr** (which contains the `kable()` function) and **kableExtra**](https://bookdown.org/yihui/rmarkdown-cookbook/tables.html)


```{r Setup, message=FALSE}

# package load 
library(Lahman) # Sean 'Lahman' Baseball Database 
library(dplyr) # A Grammar of Data Manipulation 

# tables
library(gt) # Easily Create Presentation-Ready Display Tables 
library(knitr) # A General-Purpose Package for Dynamic Report Generation in R 
library(kableExtra) # Construct Complex Table with 'kable' and Pipe Syntax 

# note: packages annotated with {annotater}
# https://github.com/luisDVA/annotater
```

#### Read and summarize the data

For this example, we'll use the data table `Pitching` in the Lahman database, which has the season performances of each pitcher in the major leagues of baseball since 1871.

Once it's loaded, the data table is filtered and summarized using dplyr.

The `Pitching` table contains a row for each pitcher's record in a single season, for a single team. A pitcher with a career of two seasons with the same team will have two rows, one for each seaons. A pitcher with a career of two seasons, who got traded mid-season of his second year, will have three rows: a single row for the first season, and then two rows for his second seasonâ€”one row for each team.

We will create a new data frame with only the pitcher records we are interested in, `df_pitcher`

```{r}
data("Pitching", package="Lahman")

# filter table to include only those records we are interested in
df_pitcher <- Pitching %>% 
  filter(yearID >= 1901,
         lgID != "FL") 

```

This data frame has fewer rows than the original `Pitching` table, but it's not what we want.

The next step is to create our summary table, using the **dplyr** function pairs `group_by` and `summarise`.

What we want is the pitcher's career total in each league. To get that, we will have to add the number of wins and losses recorded in each season.

The code below has the steps necessary to do that.

Some observations:


```{r}

df_pitcher_WL <- df_pitcher %>%
  # group_by / summarise
  group_by(playerID, lgID) %>% 
  summarise(careerW = sum(W),
            careerL = sum(L)) %>% 
  # create new variables with `mutate`
  mutate(career_decisions = careerW + careerL) %>% 
  mutate(careerWLpct = round((careerW / (careerW + careerL)), 3)) %>% 
  # filter to include only those pitchers with more than 50 decisions
  filter(career_decisions >= 50) %>% 
  # sort the list by win-loss percentage
  arrange(careerWLpct)

df_pitcher_WL
```


This has the information we want, but it's not quite there...the players are identifed through a summary value, not their full name. That information is in a separate table in the **Lahman** package, `People`.

To add that information, we will use the `left_join()` function (from **dplyr**). (For an explanation of the full range of joining functions in **dplyr**, see the chapter ["Relational Data" in _R for Data Science_](https://r4ds.had.co.nz/relational-data.html) by Garrett Grolemund and Hadley Wickham.)

```{r}

df_pitcher_WL_2 <- 
df_pitcher_WL %>% 
  left_join(People, by = "playerID")


df_pitcher_WL_50 <-
df_pitcher_WL_2 %>% 
  ungroup() %>% # need to `ungroup()` 
  select(nameLast, nameFirst, lgID, careerW, careerL, career_decisions, careerWLpct)  

#write_csv(df_pitcher_WL_50, "df_pitcher_WL_50.csv")

```


## **gt**

https://evamaerey.github.io/data_manipulation/gt



